# Description:
#   Returns weather information from weather.livedoor.com
#
#
# Commands:
#   hubot å¤©æ°— <åœ°å> - å¤©æ°—äºˆå ±æƒ…å ±ã‚’è¿”ã—ã¾ã™
#
# Author:
#   ryurock

parser = require('xml2json')
async = require('async')
require('date-utils')

weathearList = require('../config/weather_area_list.json')

module.exports = (robot) ->
  robot.respond /å¤©æ°—\s*(.*)?$/i, (msg) ->
    place  = 'æ±äº¬'
    place  = msg.match[1] if msg.match[1]?

    async.waterfall([
      (callback) ->
        weathearList.some((v,i) ->
          if v.city instanceof Array
            v.city.some((data, j) ->
              if data.title == place
                callback(null, data)
                return true
            )
          else
            if v.city.title == place
              callback(null, v.city)
              return true
        )
      , (areaData, callback) ->
        # livedoor å¤©æ°—äºˆå ±APIã®ãƒã‚° arealistã®IDãŒ5æ¡ã®ã‚‚ã®ã¯0ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã—ãªã„ã¨ã„ã‘ãªã„
        areaId =  ("0" + areaData.id).slice(-6)
        msg
          .http('http://weather.livedoor.com/forecast/webservice/json/v1')
          .query(city : areaId)
          .get() (err, res, body) ->
            json = JSON.parse(body)
            callback(null, json)
    ], (err, result) ->
      throw new Error('err catched.') if err
      forecastTime = new Date(result.publicTime)
      text = "#{place}ã®ãŠå¤©æ°—æƒ…å ±ã‚ˆï¼\n" +
      "#{forecastTime.toFormat("YYYYå¹´MMæœˆDDæ—¥HH24æ™‚MIåˆ†")}ã®äºˆå ±ã§ã™ğŸ’–\n" +
      "äºˆå ± : #{result.forecasts[0].telop}\n" +
      "#{result.description.text}\n" +
      "#{result.link}"

      msg.send text
    )
